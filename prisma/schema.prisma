generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProductTypeEnum {
  FOOD
  BEVERAGE
}

enum RestrictionEnum {
  GLUTEN_FREE
  LACTOSE_FREE
  SUGAR_FREE
  VEGAN
}

enum UserTypeEnum {
  ADMIN
  USER
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

enum CheckoutStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  EXPIRED
}

model User {
  id          Int          @id @default(autoincrement())
  email       String       @unique
  name        String?
  lastName    String?
  national_id String       @unique
  password    String
  role        UserTypeEnum @default(USER)
  cognito_sub String?      @unique

  orders Order[]
  checkouts Checkout[]
}

model Product {
  id                   Int               @id @default(autoincrement())
  name                 String
  description          String
  price                Int
  photo                String?
  restrictions         RestrictionEnum[] @default([])
  sides                Side[]
  admitsClarifications Boolean           @default(false)
  type                 ProductTypeEnum
  stock                Int               @default(0)
  deletedAt            DateTime?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  orderItems OrderItem[]
  checkoutItems CheckoutItem[]
}

model Side {
  id       Int     @id @default(autoincrement())
  name     String
  isActive Boolean @default(true)

  products       Product[]
  orderItemSides OrderItemSide[]
  checkoutItems  CheckoutItem[]
}

model Order {
  id         Int         @id @default(autoincrement())
  userId     Int
  user       User        @relation(fields: [userId], references: [id])
  status     OrderStatus @default(PENDING)
  totalPrice Int
  pickUpTime DateTime
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  orderItems OrderItem[]
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId Int
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int     @default(1)
  unitPrice Int
  notes     String?

  orderItemSide OrderItemSide?
}

model OrderItemSide {
  id          Int       @id @default(autoincrement())
  orderItemId Int       @unique
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  sideId      Int
  side        Side      @relation(fields: [sideId], references: [id])
}

model Checkout {
  id               Int             @id @default(autoincrement())
  userId           Int
  user             User            @relation(fields: [userId], references: [id])
  status           CheckoutStatus  @default(PENDING)
  totalPrice       Int
  pickUpTime       DateTime
  externalReference String         @unique
  preferenceId     String?         @unique
  initPoint        String?
  expiresAt        DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  items CheckoutItem[]
}

model CheckoutItem {
  id          Int       @id @default(autoincrement())
  checkoutId  Int
  checkout    Checkout  @relation(fields: [checkoutId], references: [id], onDelete: Cascade)
  productId   Int
  product     Product   @relation(fields: [productId], references: [id])
  quantity    Int       @default(1)
  unitPrice   Int
  notes       String?
  sideId      Int?
  side        Side?     @relation(fields: [sideId], references: [id])
}
